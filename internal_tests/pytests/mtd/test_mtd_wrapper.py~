#!/usr/bin/env python
from __future__ import print_function
import os
import sys
import re
import logging
from collections import namedtuple
import produtil
import pytest
import config_metplus
from mtd_wrapper import MtdWrapperWrapper
#import met_util as util
#from met_util import FieldObj
#from task_info import TaskInfo

# --------------------TEST CONFIGURATION and FIXTURE SUPPORT -------------
#
# The test configuration and fixture support the additional configuration
# files used in METplus
#              !!!!!!!!!!!!!!!
#              !!!IMPORTANT!!!
#              !!!!!!!!!!!!!!!
# The following two methods should be included in ALL pytest tests for METplus.
#
#
#def pytest_addoption(parser):
#    parser.addoption("-c", action="store", help=" -c <test config file>")


# @pytest.fixture
#def cmdopt(request):
#    return request.config.getoption("-c")


# -----------------FIXTURES THAT CAN BE USED BY ALL TESTS----------------
@pytest.fixture
def mtd_wrapper():
    """! Returns a default MTDWrapper with /path/to entries in the
         metplus_system.conf and metplus_runtime.conf configuration
         files.  Subsequent tests can customize the final METplus configuration
         to over-ride these /path/to values."""

    conf = metplus_config()
    return MTDWrapper(conf, None)


@pytest.fixture
def metplus_config():
    """! Create a METplus configuration object that can be
    manipulated/modified to
         reflect different paths, directories, values, etc. for individual
         tests.
    """
    try:
        if 'JLOGFILE' in os.environ:
            produtil.setup.setup(send_dbn=False, jobname='MTDWrapper',
                                 jlogfile=os.environ['JLOGFILE'])
        else:
            produtil.setup.setup(send_dbn=False, jobname='MTDWrapper')
        produtil.log.postmsg('mtd_wrapper  is starting')

        # Read in the configuration object CONFIG
        config = config_metplus.setup()
        return config

    except Exception as e:
        produtil.log.jlogger.critical(
            'mtd_wrapper failed: %s' % (str(e),), exc_info=True)
        sys.exit(2)


# ------------------------ TESTS GO HERE --------------------------


# ------------------------
#  test_find_obs_no_dated
# ------------------------
def test_mtd_by_init_all_found():
    mw = mtd_wrapper()
    mw.cg_dict['OBS_INPUT_DIR'] = pcw.p.getdir('METPLUS_BASE')+"/internal_tests/data/obs"
    v = FieldObj()
    v.obs_level = "6"
    task_info = TaskInfo()
    task_info.valid_time = "201802010000"
    task_info.lead = 0
    
    pcw.cg_dict['OBS_EXACT_VALID_TIME'] = False
    pcw.cg_dict['OBS_INPUT_DIR'] = pcw.p.getdir('METPLUS_BASE')+"/internal_tests/data/obs"
    pcw.cg_dict['OBS_INPUT_TEMPLATE'] = "{valid?fmt=%Y%m%d}_{valid?fmt=%H%M}"
    obs_file = pcw.find_obs(task_info, v)
    assert(obs_file == pcw.cg_dict['OBS_INPUT_DIR']+'/20180201_0045')
