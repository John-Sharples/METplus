# Ensemble Stat
# This file is meant to run MET ensemble_stat for the HRRRE use case.


# =============================================================================
#
##  DIR section
#
[dir]
# This is the MET config directory.
# CONFIG_DIR and the value it expands to is set as an environment variable
# and is used in the MET configuration file.
CONFIG_DIR={PARM_BASE}/use_cases/ensemble/met_config


PB2NC_INPUT_DIR = {INPUT_BASE}/ensemble/prepbufr/rap
#PB2NC_INPUT_DIR = {INPUT_BASE}/ensemble/prepbufr

#remove after refactor
#PREPBUFR_DATA_DIR = {PB2NC_INPUT_DIR}

PB2NC_OUTPUT_DIR = {OUTPUT_BASE}/rap

#OBS_ENSEMBLE_STAT_INPUT_DIR:
# Directory where the pb2nc netcdf output files reside.
# This is input netcdf obs files to ensemble_stat
#PB2NC_OUTPUT_DIR = {INPUT_BASE}/ensemble/rap
OBS_ENSEMBLE_STAT_POINT_INPUT_DIR = {PB2NC_OUTPUT_DIR}


# FCST_ENSEMBLE_STAT_INPUT_DIR:
# Parent directory to where the (Cycle) dirs reside.
# 2018070912
# This is combined with FCST_ENSEMBLE_STAT_INPUT_TEMPLATE

FCST_ENSEMBLE_STAT_INPUT_DIR = {INPUT_BASE}/ensemble

# Directory where the output of ensemble_stat is written.
ENSEMBLE_STAT_OUT_DIR = {OUTPUT_BASE}/ensemble

PREPBUFR_MODEL_DIR_NAME = rap

# =============================================================================
#
##  CONFIG section
#
[config]

## Configuration-related settings such as the process list, begin and end times, etc.
#PROCESS_LIST = EnsembleStat
#PROCESS_LIST = PB2NC, EnsembleStat
PROCESS_LIST = PB2NC

## LOOP_METHOD
## Options are: processes, times
## Looping by time- runs all items in the PROCESS_LIST for each
## initialization time and repeats until all times have been evaluated.
## Looping by processes- run each item in the PROCESS_LIST for all
## specified initialization times then repeat for the next item in the
## PROCESS_LIST.
LOOP_METHOD = times

# LOOP_BY_INIT: Currently must be set to true
LOOP_BY_INIT = true

# This is the HRRRE directory
# ie. 2018070912/postprd_mem0001 
INIT_TIME_FMT = %Y%m%d%H

# This is the HRRRE Model begining initialization cycle time you want to run.
INIT_BEG=2018070912

# This is the HRRRE Model end initialization cycle time you want to run
# The end time can be the same as the begin time, it means you are running
# METplus on 1 HRRRE cycle.
INIT_END=2018070912

# INIT_INCREMENT: 
# This is the time increment added to INIT_BEG as you loop through
# the initialization times from INIT_BEG to INIT_END. Must be >= 60
# That is, how often is the model initialized and run. It assumes you
# have this input data on disk.
INIT_INCREMENT=3600

# The hrrr ensemble forecast hours for the model.
#LEAD_SEQ = 0,
#           1,2,3,4,5,6,7,8,9,10,11,12,
#           13,14,15,16,17,18,19,20,21,22,23,24,
#           25,26,27,28,29,30,31,32,33,34,35,36

# Reduced for use case example.
# Process only 3 lead times.
LEAD_SEQ = 0,1,2

# Used in the MET config file for:  model, output_prefix
MODEL = HRRRE


## MET Configuration files for pb2nc
PB2NC_CONFIG_FILE = {PARM_BASE}/use_cases/ensemble/met_config/PB2NCConfig_HRRR

# These are appended with PB2NC to differentiate the GRID, POLY, and MESSAGE_TYPE for point_stat.
PB2NC_GRID =
PB2NC_POLY =
PB2NC_STATION_ID =
PB2NC_MESSAGE_TYPE = ADPUPA, ADPSFC, AIRCFT, PROFLR

# Leave empty to process all
OBS_BUFR_VAR_LIST = POB, QOB, TOB, ZOB, UOB, VOB, D_DPT, D_WDIR, D_WIND, D_RH, D_MIXR, D_PRMSL


#TODO : REMOVE THESE AFTER REFACTOR
# These date and time settings are defined to create a reduced use case example
# and are intended to process only 3 lead times, 
# 20181901200, 20181901300, 20181901400 rather than the full hrrre 36.
#
# Indicate the begin and end date, and interval (in hours)
BEG_TIME = 20180709
END_TIME = 20180709
#END_TIME = 20180711
INTERVAL_TIME = 1

# For processing by init time or valid time, indicate the start and end hours
# in HH format
# Hour time of first file to process
START_HOUR = 12
# Hour time of last file to process
END_HOUR = 14
#END_HOUR = 00

# start and end dates are created by combining the date with
# start and end hours (format can be hh, hhmm, or hhmmss.
START_DATE = {BEG_TIME}{START_HOUR}
END_DATE = {END_TIME}{END_HOUR}

TIME_METHOD = BY_INIT
#******************************************************************************
# ***NOTE***
#******************************************************************************
# I think these just need to be kept in sync with the MET PB2NC config file.
# They are used in the METplus module but they are not setting the values 
# in the MET config file.

# SET TIME_SUMMARY_FLAG to False. There is a bug in met-6.1.
## For defining the time periods for summarization
# False for no time summary, True otherwise
TIME_SUMMARY_FLAG = False
TIME_SUMMARY_BEG = 000000  ;; start time of time summary in HHMMSS format
TIME_SUMMARY_END = 235959  ;; end time of time summary in HHMMSS format
TIME_SUMMARY_VAR_NAMES = PMO,TOB,TDO,UOB,VOB,PWO,TOCC
TIME_SUMMARY_TYPES = min, max, range, mean, stdev, median, p80  ;; a list of the statistics to summarize

OBS_WINDOW_BEGIN = -900
OBS_WINDOW_END = 900

## OVERWRITE OPTIONS
## Don't overwrite files if they already exist.
## Set to no if you do NOT want to override existing files
## Set to yes if you do want to override existing files
OVERWRITE_NC_OUTPUT = yes

# Either conus_sfc or upper_air
VERTICAL_LOCATION = conus_sfc

# Used in the MET config file for: regrid to_grid field
GRID_VX = FCST

ENSEMBLE_STAT_CONFIG = {CONFIG_DIR}/EnsembleStatConfig_SFC

# MET_OBS_ERROR_TABLE is not required.
# If the variable is not defined, or the value is not set
# than the MET default is used.
MET_OBS_ERROR_TABLE = {CONFIG_DIR}/table_files/obs_error_table_V8.0.txt

# OBS_EXACT_VALID_TIME:
# This determine the technique used to determine the obs filename.
# Currently MUST be yes. Yes uses time substitution based on the 
# current init time and lead hour being run. No uses another method
# that currently does not work.
OBS_EXACT_VALID_TIME = yes

# FCST_VAR<n>_ vars: Currently NOT support for ensemble stat.
# Set ens, fcst, obs field variables in the MET config file.
# Variables and levels as specified in the field dictionary of the MET
# configuration file. Specify as FCST_VARn_NAME, FCST_VARn_LEVELS,
# (optional) FCST_VARn_OPTION

FCST_VAR1_NAME = TMP
FCST_VAR1_LEVELS = Z2
FCST_VAR1_THRESH = >=283, >=288, >=293, >=298, >=303

ENS_VAR1_NAME = TMP
ENS_VAR1_LEVELS = Z02
ENS_VAR1_THRESH = >=283, >=288, >=293, >=298, >=304

FCST_VAR2_NAME = DPT
FCST_VAR2_LEVELS = Z2
FCST_VAR2_THRESH = >=278, >=283, >=288, >=293, >=298

FCST_VAR3_NAME = UGRD
FCST_VAR3_LEVELS = Z10
FCST_VAR3_THRESH = <=-10, <=-5, <=-2, >=2, >=5, >=10

FCST_VAR4_NAME = VGRD
FCST_VAR4_LEVELS = Z10
FCST_VAR4_THRESH = <=-10, <=-5, <=-2, >=2, >=5, >=10

FCST_VAR5_NAME = WIND
FCST_VAR5_LEVELS = Z10
FCST_VAR5_THRESH = >=2, >=4, >=6, >=8, >=10

OBS_VAR1_OPTIONS = ens_ssvar_bin_size = 1.0; ens_phist_bin_size = 0.05;
OBS_VAR2_OPTIONS = {OBS_VAR1_OPTIONS}
OBS_VAR3_OPTIONS = {OBS_VAR1_OPTIONS}
OBS_VAR4_OPTIONS = {OBS_VAR1_OPTIONS}
OBS_VAR5_OPTIONS = {OBS_VAR1_OPTIONS}

#FCST_VAR3_OPTIONS = GRIB_lvl_typ = 200

# =============================================================================
#
##  FILENAME TEMPLATES section
#
[filename_templates]

PB2NC_INPUT_TEMPLATE = {da_init?fmt=%Y%m%d}/{da_init?fmt=%Y%j%H%M}.rap.t{da_init?fmt=%2H}z.prepbufr.tm{offset?fmt=%2H}.{da_init?fmt=%Y%m%d}

PB2NC_OUTPUT_TEMPLATE = {valid?fmt=%Y%m%d}/{valid?fmt=%Y%m%d%H}.rap.nc

# Output Netcdf files from pb2nc, input to ensemble_stat
# Valid keywords are: valid, lead, init, 
#OBS_INPUT_TEMPLATE = {valid?fmt=%Y%j}{lead?fmt=%HH}{valid?fmt=%M}.rap.t{lead?fmt=%HH}z.tm00.{valid?fmt=%Y%m%d}.nc
#OBS_ENSEMBLE_STAT_POINT_INPUT_TEMPLATE = {valid?fmt=%Y%j%H%M}.rap.t{valid?fmt=%H}z.tm00.{valid?fmt=%Y%m%d}.nc

OBS_ENSEMBLE_STAT_POINT_INPUT_TEMPLATE = {PB2NC_OUTPUT_TEMPLATE}

# FCST_ENSEMBLE_STAT_INPUT_TEMPLATE:
# There are currently two ways supported to define your ensemble members. 
# Either using filename wildcards, NOT enclosed in {}, ie. ? , *
# or explicitly list each member.

# The Number of ensemble members 
# This must match the number of members defined or returned 
# from the FCST_ENSEMBLE_STAT_INPUT_TEMPLATE pattern.
#N_ENSEMBLE_MEMBERS = 9
# Reduced for use case example.
N_ENSEMBLE_MEMBERS = 2

# The time format keywords supported, in either case are: init?fmt= and lead?fmt=
FCST_ENSEMBLE_STAT_INPUT_TEMPLATE =
    {init?fmt=%Y%m%d%H}/postprd_mem0001/wrfprs_conus_mem0001_{lead?fmt=%HH}.grib2,
    {init?fmt=%Y%m%d%H}/postprd_mem0002/wrfprs_conus_mem0002_{lead?fmt=%HH}.grib2


#FCST_ENSEMBLE_STAT_INPUT_TEMPLATE = {init?fmt=%Y%m%d%H}/postprd_mem000?/wrfprs_conus_mem000?_{lead?fmt=%HH}.grib2

#FCST_ENSEMBLE_STAT_INPUT_TEMPLATE =
#    {init?fmt=%Y%m%d%H}/postprd_mem0001/wrfprs_conus_mem0001_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0002/wrfprs_conus_mem0002_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0003/wrfprs_conus_mem0003_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0004/wrfprs_conus_mem0004_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0005/wrfprs_conus_mem0005_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0006/wrfprs_conus_mem0006_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0007/wrfprs_conus_mem0007_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0008/wrfprs_conus_mem0008_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0009/wrfprs_conus_mem0009_{lead?fmt=%HH}.grib2


# =============================================================================
#
## REGEX PATTERN section
#
#[regex_pattern]

# Currently no patterns being used for ensemble stat use case.


# BELOW THIS LINE ARE ENSEMBLE STAT CONF FILE NOTES: No more settings.
# =============================================================================
#


# THIS IS HOW GSD HRRRE Ensemble member input  DIRS WERE  SETUP .... 
# This is a 36 hour hrrre forecast with 201819012 as the init time.
# 00 is the init 01-36 are the forecast valid times ... ensemble stat is run 37 times.
# Each prepbufr netcdf input file is valid for the ensemble member files valid forecast time ...
#   so 2018070912 + 36 hours is 20180711 00Z ...
#
# Where all the ensemble members are
# ensemble member fcst file list for first set 00:  
#   {FCST_ENSEMBLE_STAT_INPUT_DIR}/ens_fcst_file_list_00
#     {FCST_ENSEMBLE_STAT_INPUT_DIR}/2018070912/postprd_mem0001/wrfprs_conus_mem0001_00.grib2
#     ...
#     {FCST_ENSEMBLE_STAT_INPUT_DIR}/2018070912/postprd_mem0009/wrfprs_conus_mem0009_00.grib2
#   ...
# ensemble member fcst file list for last set to process 36:  
#   {FCST_ENSEMBLE_STAT_INPUT_DIR}/ens_fcst_file_list_36
#     {FCST_ENSEMBLE_STAT_INPUT_DIR}/2018070912/postprd_mem0001/wrfprs_conus_mem0001_36.grib2
#     ...
#     {FCST_ENSEMBLE_STAT_INPUT_DIR}/2018070912/postprd_mem0001/wrfprs_conus_mem0009_36.grib2
#
# command that is run for 00
# ensemble_stat ens_fcst_file_list_00 EnsembleStatConfig_SFC 
#       -point_obs 2018070912/prepbufr/obs/prepbufr/20181901200.rap.t12z.prepbufr.tm00.20180709.nc -outdir . -v 2
# ...
# command that is run for 36
# ensemble_stat ens_fcst_file_list_36 EnsembleStatConfig_SFC 
#       -point_obs 2018070912/prepbufr/obs/prepbufr/20181920000.rap.t00z.prepbufr.tm00.20180711.nc -outdir . -v 2
#

[regex_pattern]
PREPBUFR_DIR_REGEX = .*\/rap\/(2[0-9]{7}).*
PREPBUFR_FILE_REGEX = .*