# Ensemble Stat
# This file is meant to run MET ensemble_stat for the HRRRE use case.


# =============================================================================
#
##  DIR section
#
[dir]
# This is the MET config directory.
# CONFIG_DIR and the value it expands to is set as an environment variable
# and is used in the MET configuration file.
CONFIG_DIR={PARM_BASE}/use_cases/ensemble/met_config


#OBS_ENSEMBLE_STAT_INPUT_DIR:
# Directory where the pb2nc netcdf output files reside.
# This is input netcdf obs files to ensemble_stat
PB2NC_OUTPUT_DIR = {OUTPUT_BASE}/rap
OBS_ENSEMBLE_STAT_INPUT_DIR = {PB2NC_OUTPUT_DIR}


# FCST_ENSEMBLE_STAT_INPUT_DIR:
# Parent directory to where the (Cycle) dirs reside.
# 2018070912
# This is combined with FCST_ENSEMBLE_STAT_INPUT_TEMPLATE

FCST_ENSEMBLE_STAT_INPUT_DIR = {INPUT_BASE}

# Directory where the output of ensemble_stat is written.
ENSEMBLE_STAT_OUT_DIR = {OUTPUT_BASE}/ensemble

# =============================================================================
#
##  CONFIG section
#
[config]

## Configuration-related settings such as the process list, begin and end times, etc.
PROCESS_LIST = EnsembleStat
#PROCESS_LIST = PB2NC, EnsembleStat

## LOOP_METHOD
## Options are: processes, times
## Looping by time- runs all items in the PROCESS_LIST for each
## initialization time and repeats until all times have been evaluated.
## Looping by processes- run each item in the PROCESS_LIST for all
## specified initialization times then repeat for the next item in the
## PROCESS_LIST.
LOOP_METHOD = processes

# LOOP_BY_INIT: Currently must be set to true
LOOP_BY_INIT = true

# This is the HRRRE directory
# ie. 2018070912/postprd_mem0001 
INIT_TIME_FMT = %Y%m%d%H

# This is the HRRRE Model begining initialization cycle time you want to run.
INIT_BEG=2018070912

# This is the HRRRE Model end initialization cycle time you want to run
# The end time can be the same as the begin time, it means you are running
# METplus on 1 HRRRE cycle.
INIT_END=2018070912

# INIT_INCREMENT: 
# This is the time increment added to INIT_BEG as you loop through
# the initialization times from INIT_BEG to INIT_END. Must be >= 60
# That is, how often is the model initialized and run. It assumes you
# have this input data on disk.
INIT_INCREMENT=3600

# The forecast hours for the model.
LEAD_SEQ = 0,
           1,2,3,4,5,6,7,8,9,10,11,12,
           13,14,15,16,17,18,19,20,21,22,23,24,
           25,26,27,28,29,30,31,32,33,34,35,36

# The forecast begin and end leads times for the model.
FCST_MIN_FCST = 0  ;; Optional if this variable does not exist it defaults to 0
FCST_MAX_FORECAST = 36

FCST_INIT_INTERVAL = 1

# Used in the MET config file for:  model, output_prefix
MODEL = HRRRE

# Used in the MET config file for: regrid to_grid field
GRID_VX = FCST

ENSEMBLE_STAT_CONFIG = {CONFIG_DIR}/EnsembleStatConfig_SFC

# MET_OBS_ERROR_TABLE is not required.
# If the variable is not defined, or the value is not set
# than the MET default is used.
MET_OBS_ERROR_TABLE = {CONFIG_DIR}/table_files/obs_error_table_V8.0.txt

# OBS_EXACT_VALID_TIME:
# This determine the technique used to determine the obs filename.
# Currently MUST be yes. Yes uses time substitution based on the 
# current init time and lead hour being run. No uses another method
# that currently does not work.
OBS_EXACT_VALID_TIME = yes

OBS_WINDOW_BEGIN = -900
OBS_WINDOW_END = 900

# FCST_VAR<n>_ vars: Currently NOT support for ensemble stat.
# Set ens, fcst, obs field variables in the MET config file.
# Variables and levels as specified in the field dictionary of the MET
# configuration file. Specify as FCST_VARn_NAME, FCST_VARn_LEVELS,
# (optional) FCST_VARn_OPTION

#FCST_VAR1_NAME = TMP
#FCST_VAR1_LEVELS = Z2

#FCST_VAR2_NAME = RH
#FCST_VAR2_LEVELS = Z2

#FCST_VAR3_NAME = TCDC
#FCST_VAR3_LEVELS = L0
#FCST_VAR3_OPTIONS = GRIB_lvl_typ = 200

# =============================================================================
#
##  FILENAME TEMPLATES section
#
[filename_templates]

# Output Netcdf files from pb2nc, input to ensemble_stat
# Valid keywords are: valid, lead, init, 
#OBS_INPUT_TEMPLATE = {valid?fmt=%Y%j}{lead?fmt=%HH}{valid?fmt=%M}.rap.t{lead?fmt=%HH}z.tm00.{valid?fmt=%Y%m%d}.nc
OBS_INPUT_TEMPLATE = {valid?fmt=%Y%j%H%M}.rap.t{valid?fmt=%H}z.tm00.{valid?fmt=%Y%m%d}.nc

# FCST_ENSEMBLE_STAT_INPUT_TEMPLATE:
# There are currently two ways supported to define your ensemble members. 
# Either using filename wildcards, NOT enclosed in {}, ie. ? , *
# or explicitly list each member.

# The Number of ensemble members 
N_ENSEMBLE_MEMBERS = 9

# The time format keywords supported, in either case are: init?fmt= and lead?fmt=
FCST_ENSEMBLE_STAT_INPUT_TEMPLATE = {init?fmt=%Y%m%d%H}/postprd_mem000?/wrfprs_conus_mem000?_{lead?fmt=%HH}.grib2

#FCST_ENSEMBLE_STAT_INPUT_TEMPLATE =
#    {init?fmt=%Y%m%d%H}/postprd_mem0001/wrfprs_conus_mem0001_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0002/wrfprs_conus_mem0002_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0003/wrfprs_conus_mem0003_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0004/wrfprs_conus_mem0004_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0005/wrfprs_conus_mem0005_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0006/wrfprs_conus_mem0006_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0007/wrfprs_conus_mem0007_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0008/wrfprs_conus_mem0008_{lead?fmt=%HH}.grib2,
#    {init?fmt=%Y%m%d%H}/postprd_mem0009/wrfprs_conus_mem0009_{lead?fmt=%HH}.grib2


# =============================================================================
#
## REGEX PATTERN section
#
#[regex_pattern]

# Currently no patterns being used for ensemble stat use case.


# BELOW THIS LINE ARE ENSEMBLE STAT CONF FILE NOTES: No more settings.
# =============================================================================
#


# THIS IS HOW GSD HRRRE Ensemble member input  DIRS WERE  SETUP .... 
# This is a 36 hour hrrre forecast with 201819012 as the init time.
# 00 is the init 01-36 are the forecast valid times ... ensemble stat is run 37 times.
# Each prepbufr netcdf input file is valid for the ensemble member files valid forecast time ...
#   so 2018070912 + 36 hours is 20180711 00Z ...
#
# Where all the ensemble members are
# ensemble member fcst file list for first set 00:  
#   {INPUT_BASE}/ens_fcst_file_list_00
#     {INPUT_BASE}/2018070912/postprd_mem0001/wrfprs_conus_mem0001_00.grib2
#     ...
#     {INPUT_BASE}/2018070912/postprd_mem0009/wrfprs_conus_mem0009_00.grib2
#   ...
# ensemble member fcst file list for last set to process 36:  
#   {INPUT_BASE}/ens_fcst_file_list_36
#     {INPUT_BASE}/2018070912/postprd_mem0001/wrfprs_conus_mem0001_36.grib2
#     ...
#     {INPUT_BASE}/2018070912/postprd_mem0001/wrfprs_conus_mem0009_36.grib2
#
# command that is run for 00
# ensemble_stat ens_fcst_file_list_00 EnsembleStatConfig_SFC 
#       -point_obs 2018070912/prepbufr/obs/prepbufr/20181901200.rap.t12z.prepbufr.tm00.20180709.nc -outdir . -v 2
# ...
# command that is run for 36
# ensemble_stat ens_fcst_file_list_36 EnsembleStatConfig_SFC 
#       -point_obs 2018070912/prepbufr/obs/prepbufr/20181920000.rap.t00z.prepbufr.tm00.20180711.nc -outdir . -v 2
#

